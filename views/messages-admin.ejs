<%- include('partials/head', { title: 'Messages', showBack: true }) %>
<div class="mb-3">
  <h2 class="text-xl font-semibold">All Messages</h2>
  <div class="mt-3 flex gap-2">
    <input id="msg-input" class="flex-1 min-w-0 px-3 py-2 border rounded" placeholder="Type message to broadcast to everyone..." />
    <button id="msg-send" class="btn-primary">Send to Everyone</button>
  </div>
</div>
<div class="bg-white rounded-xl shadow divide-y">
  <% (messages||[]).forEach(function(m){
       const isAdmin = m.side === 'admin';
  %>
    <div class="p-3 flex items-start gap-3">
      <div class="text-xs px-2 py-0.5 rounded-full <%= isAdmin ? 'bg-indigo-100 text-indigo-700' : (m.server===2 ? 'bg-pink-100 text-pink-700' : 'bg-blue-100 text-blue-700') %>"><%= isAdmin ? 'Admin' : (m.server===2 ? 'Girls' : 'Boys') %></div>
      <div class="text-xs px-2 py-0.5 rounded bg-slate-100"><%= isAdmin ? 'admin' : m.side %></div>
      <div class="flex-1"><%= m.text %></div>
      <div class="text-xs text-slate-500"><%= new Date(m.ts).toLocaleString(undefined,{hour:'numeric',minute:'2-digit',hour12:true,year:'numeric',month:'short',day:'2-digit'}) %></div>
    </div>
  <% }) %>
</div>
<script>
  (function(){
    const $input = document.getElementById('msg-input');
    const $send = document.getElementById('msg-send');
    async function send(){
      const text = String($input.value||'').trim();
      if(!text) return;
      $send.disabled = true;
      try{
        const res = await fetch('/api/messages', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ text, side: 'admin', broadcast: true }) });
        if(res.ok){ $input.value=''; try{ showToast('Sent to everyone'); }catch{} }
      } finally { $send.disabled = false; }
    }
    $send?.addEventListener('click', send);
    $input?.addEventListener('keydown', (e)=>{ if(e.key==='Enter') send(); });
  })();
</script>
<%- include('partials/foot') %>
